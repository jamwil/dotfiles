# --- helpers -----------------------------------------------------------------
# zsh-native "command exists" check
has() { (( $+commands[$1] )); }

# --- aliases ------------------------------------------------------------------
if has lsd; then
  alias ll='lsd -alhF'
else
  alias ll='ls -alhF'
fi

if has cloc; then
  alias cloc='cloc --vcs=git'
fi

if has nginx; then
  alias nginx='nginx -g "daemon off;"'
fi

{{ if eq .chezmoi.os "linux" }}
{{   if (.chezmoi.kernel.osrelease | lower | contains "microsoft") }}
alias neovide='/mnt/c/Program\ Files/Neovide/neovide.exe --wsl'
{{   end }}
{{ end }}

# Mac-specific
{{ if (eq .chezmoi.os "darwin") -}}
{{- end }}

## M1 Mac-specific
{{ if (and (eq .chezmoi.os "darwin") (eq .chezmoi.arch "arm64" )) -}}
if [[ -x /opt/homebrew/bin/brew ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi

if [[ -x /Applications/Tailscale.app/Contents/MacOS/Tailscale ]]; then
  alias tailscale='/Applications/Tailscale.app/Contents/MacOS/Tailscale'
fi

# Rosetta aliases
alias ros='arch -x86_64'
if [[ -x /usr/local/bin/brew ]]; then
  alias rbrew='arch -x86_64 /usr/local/bin/brew'
fi

# pymssql on arm64
export LDFLAGS="-L/opt/homebrew/opt/freetds/lib -L/opt/homebrew/opt/openssl@3/lib"
export CFLAGS="-I/opt/homebrew/opt/freetds/include"
export CPPFLAGS="-I/opt/homebrew/opt/openssl@3/include"

# openjdk
export PATH="$PATH:/opt/homebrew/opt/openjdk/bin"
{{- end }}

# --- env ----------------------------------------------------------------------
export PATH="$PATH:$HOME/.local/bin"

# Miscellaneous
export EDITOR=vim
export GPG_TTY="$TTY"
export RICH_THEME=monokai

if [[ -n "${XDG_RUNTIME_DIR:-}" ]]; then
  export SSH_AUTH_SOCK="$XDG_RUNTIME_DIR/ssh-agent.socket"
fi

# Package manager paths
export PATH="$HOME/bin:$PATH"
export PATH="$PATH:$HOME/go/bin"
export PATH="$PATH:$HOME/.dotnet/tools"

# Cargo
export PATH="$PATH:$HOME/.cargo/bin"

# Don't execute cargo at shell startup (the old alias expanded command substitution)
# Usage: cargo-update
cargo-update() {
  if ! has cargo; then
    print -u2 "cargo-update: cargo not found"
    return 127
  fi

  local crates
  crates=$(cargo install --list 2>/dev/null | grep -E '^[a-z0-9_-]+ v[0-9.]+:$' | cut -f1 -d' ')
  if [[ -z "$crates" ]]; then
    print -u2 "cargo-update: no installed crates found"
    return 0
  fi

  cargo install ${(f)crates}
}

# iterm2
[[ -r "$HOME/.iterm2_shell_integration.zsh" ]] && source "$HOME/.iterm2_shell_integration.zsh"

# atuin
if [[ -d "$HOME/.atuin/bin" ]]; then
  export PATH="$PATH:$HOME/.atuin/bin"
fi
if has atuin; then
  eval "$(atuin init zsh --disable-up-arrow)"
fi

# zsh-autosuggestions
{{ if (eq .chezmoi.os "darwin") -}}
# Avoid calling `brew --prefix` during startup; just probe common locations.
for _zsh_as in \
  /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh \
  /usr/local/share/zsh-autosuggestions/zsh-autosuggestions.zsh; do
  [[ -r "$_zsh_as" ]] && source "$_zsh_as" && break
done
unset _zsh_as
{{- else -}}
if [[ -r /usr/share/zsh-autosuggestions/zsh-autosuggestions.zsh ]]; then
  source /usr/share/zsh-autosuggestions/zsh-autosuggestions.zsh
elif [[ -r "$HOME/.zsh/zsh-autosuggestions/zsh-autosuggestions.zsh" ]]; then
  source "$HOME/.zsh/zsh-autosuggestions/zsh-autosuggestions.zsh"
fi
{{- end }}

# direnv
if has direnv; then
  eval "$(direnv hook zsh)"
  if [[ -n "${NVIM:-}" ]]; then
    direnv reload
  fi
fi

# powerlevel10k
[[ -r "$HOME/powerlevel10k/powerlevel10k.zsh-theme" ]] && source "$HOME/powerlevel10k/powerlevel10k.zsh-theme"

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ -r "$HOME/.p10k.zsh" ]] && source "$HOME/.p10k.zsh"

# Vim mode
bindkey -v

# Make chromium not be annoying
export GOOGLE_API_KEY="no"
export GOOGLE_DEFAULT_CLIENT_ID="no"
export GOOGLE_DEFAULT_CLIENT_SECRET="no"

# Use the new neovim config
export NVIM_APPNAME="nvim-11"

# bun
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"
